<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FID Checker — Mini App</title>

  <!-- Ubah HOME_URL jika perlu -->
  <!-- HOME_URL = https://scorecast-beryl.vercel.app/ -->
  <meta name="fc:miniapp" content='{"homeURL":"https://scorecast-beryl.vercel.app/","icon":"https://scorecast-beryl.vercel.app/assets/icon-192.png"}'>
  <meta property="og:title" content="FID Checker">
  <meta property="og:description" content="See your Farcaster FID & profile photo instantly.">
  <meta property="og:image" content="https://scorecast-beryl.vercel.app/assets/icon-192.png">
  <meta name="theme-color" content="#6F42C1">

  <style>
    :root{
      --bg: #f7f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #6F42C1; /* purple */
      --text: #0f172a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:var(--text);background:linear-gradient(180deg, #fafafa, var(--bg));-webkit-font-smoothing:antialiased}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:420px;background:var(--card);border-radius:14px;padding:22px;box-shadow:0 10px 30px rgba(16,24,40,0.06);border:1px solid rgba(16,24,40,0.03)}
    .top{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .brand{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#8b5cf6);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
    .title{font-size:16px;font-weight:700}
    .subtitle{font-size:13px;color:var(--muted);margin-top:4px}

    .center{display:flex;flex-direction:column;align-items:center;gap:14px;padding:10px 6px}
    .avatar{width:112px;height:112px;border-radius:50%;object-fit:cover;border:6px solid rgba(111,66,193,0.08);background:linear-gradient(180deg,rgba(0,0,0,0.02),rgba(255,255,255,0.02))}
    .fid-row{display:flex;align-items:center;gap:10px}
    .fid-box{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;padding:8px 12px;border-radius:10px;background:#f3f4f6;border:1px solid rgba(15,23,42,0.04);min-width:170px;text-align:center;font-weight:600}
    .btn{padding:8px 12px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(15,23,42,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite;margin:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{color:#b91c1c;background:#fff1f2;padding:8px;border-radius:8px;font-size:13px;text-align:center}
    @media (max-width:420px){.avatar{width:96px;height:96px}.fid-box{min-width:130px}}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" role="main" aria-labelledby="appTitle">
      <div class="top">
        <div class="brand">FID</div>
        <div>
          <div id="appTitle" class="title">Farcaster FID Checker</div>
          <div class="subtitle">Automatic profile & FID detection</div>
        </div>
      </div>

      <div class="center" id="card">
        <img id="avatar" class="avatar" src="assets/default-avatar.png" alt="profile picture">
        <div class="fid-row" aria-live="polite">
          <div id="fid" class="fid-box">—</div>
          <button id="copyBtn" class="btn" aria-label="Copy FID">Copy</button>
        </div>

        <div id="status" class="muted">Detecting your Farcaster profile…</div>
        <div id="spinner" class="spinner" aria-hidden="true"></div>
        <div id="error" class="error" style="display:none"></div>
      </div>
    </section>
  </main>

  <script type="module">
    // Final app script — minimal, robust, English UI strings can be changed if needed.
    const SDK_URL = "https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk/dist/miniapp-sdk.esm.js";
    const avatarEl = document.getElementById('avatar');
    const fidEl = document.getElementById('fid');
    const statusEl = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const errorEl = document.getElementById('error');
    const copyBtn = document.getElementById('copyBtn');

    function showSpinner(){ spinner.style.display = 'block'; }
    function hideSpinner(){ spinner.style.display = 'none'; }
    function showError(msg){ errorEl.style.display='block'; errorEl.textContent = msg; hideSpinner(); }
    function clearError(){ errorEl.style.display='none'; errorEl.textContent=''; }

    async function loadSDK(){
      try {
        return await import(SDK_URL);
      } catch (e) {
        return null;
      }
    }

    function setFID(fid){
      fidEl.textContent = String(fid ?? 'unknown');
    }

    function setAvatar(url){
      if(!url) { avatarEl.src = 'assets/default-avatar.png'; return; }
      avatarEl.src = url;
    }

    function setupCopy(fidValue){
      copyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(String(fidValue));
          copyBtn.textContent = 'Copied';
          setTimeout(()=> copyBtn.textContent = 'Copy', 1200);
        } catch (e) {
          console.warn('Clipboard failed', e);
          copyBtn.textContent = 'Copy';
        }
      };
    }

    // Demo user for browser preview (preview=true) or when SDK missing
    const DEMO = {
      fid: '241470',
      avatar: 'assets/default-avatar.png'
    };

    // Render user object tolerant to variations in SDK shape
    function renderUser(user){
      clearError();
      hideSpinner();
      statusEl.textContent = 'You are signed in';
      const fid = user?.fid ?? user?.userId ?? user?.id ?? 'unknown';
      const avatar = user?.profile?.picture ?? user?.avatar ?? user?.image ?? null;
      setFID(fid);
      setAvatar(avatar);
      setupCopy(fid);
    }

    // Login button if host supports auth
    function renderLoginButton(auth){
      hideSpinner();
      statusEl.textContent = 'Sign in required — tap to sign in';
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Sign in';
      btn.style.marginTop = '10px';
      btn.onclick = async () => {
        try {
          const u = await auth.login();
          if(u) renderUser(u);
        } catch (e) {
          showError('Sign-in failed');
        }
      };
      document.getElementById('card').appendChild(btn);
    }

    // Main logic
    async function start(){
      showSpinner();
      const urlParams = new URLSearchParams(window.location.search);
      const forcePreview = urlParams.get('preview') === 'true';

      const sdk = await loadSDK();

      // If preview forced or SDK missing → show demo (prevents infinite spinner in web preview)
      if(forcePreview || !sdk){
        // short delay to mimic load
        setTimeout(()=> {
          hideSpinner();
          statusEl.textContent = 'Preview (demo)';
          setFID(DEMO.fid);
          setAvatar(DEMO.avatar);
          setupCopy(DEMO.fid);
        }, 450);
        if(!sdk) console.info('SDK not found — running demo preview.');
        return;
      }

      // Inside Farcaster client (SDK available)
      try {
        sdk.ready?.();
      } catch (e) { /* non-critical */ }

      try {
        let user = null;
        if(typeof sdk.auth?.getCurrentUser === 'function'){
          try { user = await sdk.auth.getCurrentUser(); } catch(e){ /* ignore */ }
        }

        if(!user && typeof sdk.auth?.login === 'function'){
          try { user = await sdk.auth.login({ prompt:false }); } catch(e){ /* might require gesture */ }
        }

        if(!user && typeof sdk.detectHostCapabilities === 'function'){
          const caps = await sdk.detectHostCapabilities();
          if(caps?.auth && typeof sdk.auth?.login === 'function'){
            renderLoginButton(sdk.auth);
            return;
          }
        }

        if(user){
          renderUser(user);
        } else {
          showError('No Farcaster user detected. Open this Mini App inside the Farcaster client to sign in.');
        }
      } catch (err) {
        console.error(err);
        showError('Unexpected error: ' + (err?.message || String(err)));
      }
    }

    window.addEventListener('load', start);
  </script>
</body>
</html>
