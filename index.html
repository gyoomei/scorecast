<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FID Checker — Mini App</title>

  <!-- MINI APP META (required) -->
  <meta name="fc:miniapp" content='{"homeURL":"https://fidchecker.pages.dev/","icon":"https://fidchecker.pages.dev/assets/icon-1024.png"}' />
  <meta property="og:title" content="FID Checker" />
  <meta property="og:description" content="Automatically displays your Farcaster FID and profile photo." />
  <meta property="og:image" content="https://fidchecker.pages.dev/assets/icon-1024.png" />
  <meta name="theme-color" content="#6F42C1" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
    :root{--bg:#6F42C1;--card:rgba(255,255,255,0.06);--accent:#fff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;color:var(--accent);background:var(--bg)}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:100%;max-width:460px;background:var(--card);border-radius:16px;padding:26px;text-align:center;backdrop-filter:blur(6px);box-shadow:0 18px 40px rgba(0,0,0,0.25)}
    .badge{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#7f56f4,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;margin:0 auto 8px}
    h1{font-size:18px;margin:0}
    p.sub{margin:6px 0 14px;color:rgba(255,255,255,0.95);font-size:13px}
    .avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid rgba(255,255,255,0.12);background:#eee;margin:8px auto}
    .fid-row{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:16px}
    .fid-box{font-family:ui-monospace,Menlo,monospace;background:rgba(255,255,255,0.06);padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);min-width:170px;text-align:center;font-weight:700}
    .btn{background:#fff;color:var(--bg);padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .status{margin-top:14px;font-size:13px;color:rgba(255,255,255,0.9)}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,0.12);border-top-color:#fff;animation:spin 1s linear infinite;margin:14px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .signin{margin-top:12px}
    .error{margin-top:10px;background:rgba(255,255,255,0.08);padding:8px;border-radius:8px;color:#fff;font-size:13px;display:none}
    @media(max-width:420px){.avatar{width:96px;height:96px}.fid-box{min-width:120px}}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" role="main" aria-labelledby="title">
      <div class="badge">FID</div>
      <h1 id="title">Farcaster FID Checker</h1>
      <p class="sub" id="subtitle">Auto shows your Farcaster FID</p>

      <img id="avatar" class="avatar" src="/assets/default-avatar.png" alt="profile picture" />

      <div class="fid-row" aria-live="polite">
        <div id="fid" class="fid-box">—</div>
        <button id="copyBtn" class="btn" aria-label="Copy FID">Copy</button>
      </div>

      <div id="status" class="status">Detecting your Farcaster profile…</div>
      <div id="spinner" class="spinner" aria-hidden="true"></div>

      <div class="signin" id="signinContainer" style="display:none">
        <button id="signBtn" class="btn">Sign in</button>
      </div>

      <div id="error" class="error"></div>
    </section>
  </main>

  <script type="module">
    const avatarEl = document.getElementById('avatar');
    const fidEl = document.getElementById('fid');
    const statusEl = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const errorEl = document.getElementById('error');
    const copyBtn = document.getElementById('copyBtn');
    const signBtn = document.getElementById('signBtn');
    const signinContainer = document.getElementById('signinContainer');

    function showSpinner(){ spinner.style.display = 'block'; }
    function hideSpinner(){ spinner.style.display = 'none'; }
    function showError(msg){ errorEl.style.display = 'block'; errorEl.textContent = msg; hideSpinner(); }
    function clearError(){ errorEl.style.display = 'none'; errorEl.textContent = ''; }

    function setUser(fid, avatar){
      fidEl.textContent = fid ?? 'unknown';
      avatarEl.src = avatar ?? '/assets/default-avatar.png';
      copyBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(fid); copyBtn.textContent = 'Copied'; setTimeout(()=> copyBtn.textContent = 'Copy',1200); } catch(e){ console.warn(e) }
      };
    }

    const SDK_CDN = 'https://esm.sh/@farcaster/miniapp-sdk';

    async function tryGetUserThroughSDK(sdk){
      // try multiple possible SDK methods to fetch viewer/user (robust across versions)
      const tryFns = [
        async () => sdk.auth && sdk.auth.getCurrentUser && await sdk.auth.getCurrentUser(),
        async () => sdk.auth && sdk.auth.getViewer && await sdk.auth.getViewer(),
        async () => sdk.viewer && sdk.viewer.getCurrentUser && await sdk.viewer.getCurrentUser(),
        async () => sdk.viewer && sdk.viewer.getViewer && await sdk.viewer.getViewer()
      ];

      for(const fn of tryFns){
        try{
          const u = await fn();
          if(u) return u;
        }catch(e){
          // ignore and try next
        }
      }
      return null;
    }

    async function init(){
      showSpinner();
      const isPreview = new URLSearchParams(location.search).get('preview') === 'true';
      let sdk = null;

      try{
        const mod = await import(SDK_CDN);
        sdk = mod.sdk ?? mod.default ?? mod;
      }catch(e){
        console.info('SDK import failed (preview mode):', e);
      }

      // if no sdk or preview -> demo fallback
      if(!sdk || isPreview){
        hideSpinner();
        statusEl.textContent = 'Preview mode';
        setUser('241470','/assets/default-avatar.png');
        return;
      }

      clearError();

      // try to get user silently
      let user = null;
      try {
        user = await tryGetUserThroughSDK(sdk);
      } catch(e){
        console.warn('silent fetch user failed', e);
      }

      // try silent login if no user
      if(!user && sdk.auth && typeof sdk.auth.login === 'function'){
        try{
          user = await sdk.auth.login({ prompt: false }).catch(()=>null);
        }catch(e){}
      }

      // If still no user, show Sign in button (requires user gesture)
      if(!user){
        hideSpinner();
        statusEl.textContent = 'Not signed in — open in Farcaster to sign in';
        signinContainer.style.display = 'block';
        signBtn.onclick = async () => {
          try{
            signinContainer.style.display = 'none';
            showSpinner();
            // call interactive login
            if(sdk.auth && typeof sdk.auth.login === 'function'){
              const u = await sdk.auth.login({ prompt: true });
              user = u;
            } else {
              throw new Error('Auth.login not available on SDK');
            }
            if(user){
              // set UI
              const fid = user?.fid ?? user?.userId ?? user?.id ?? 'unknown';
              const avatar = user?.profile?.picture ?? user?.avatar ?? '/assets/default-avatar.png';
              setUser(fid, avatar);
              statusEl.textContent = 'Signed in';
            } else {
              statusEl.textContent = 'Sign in cancelled';
            }
            // call ready so host hides splash
            if(sdk.actions && typeof sdk.actions.ready === 'function'){
              try{ await sdk.actions.ready(); } catch(e){ console.warn('ready failed',e); }
            }
            hideSpinner();
          }catch(err){
            console.error(err);
            showError('Sign in failed: ' + (err?.message||String(err)));
          }
        };
        return;
      }

      // user exists — show info
      try{
        const fid = user?.fid ?? user?.userId ?? user?.id ?? 'unknown';
        const avatar = user?.profile?.picture ?? user?.avatar ?? '/assets/default-avatar.png';
        setUser(fid, avatar);
        statusEl.textContent = 'Signed in';

        // call ready so host hides splash
        if(sdk.actions && typeof sdk.actions.ready === 'function'){
          try{ await sdk.actions.ready(); console.info('sdk.actions.ready() called'); } catch(e){ console.warn('ready failed', e); }
        }
      }catch(e){
        console.error(e);
        showError('Could not load user: ' + (e?.message||String(e)));
      } finally {
        hideSpinner();
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
